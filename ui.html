<div class="wrapper">
  <div class="section">
    <label class="checkbox">
      <input type="checkbox" id="applyTracking" class="checkbox__input" checked>
      <span id="checkboxLabel" class="checkbox__label"></span>
    </label>
  </div>
  <div class="section">
    <button id="startButton" class="button button--primary" disabled></button>
  </div>
  <div class="section">
    <span id="statusText" class="status-text"></span>
  </div>
</div>

<style>
  .wrapper {
    padding: 8px;
    background-color: var(--figma-color-bg);
  }

  .section {
    margin-bottom: 10px;
  }

  .section:last-child {
    margin-bottom: 0;
  }

  .checkbox {
    display: flex;
    align-items: center;
    gap: 4px;
    padding-left: 0px;
  }

  .checkbox__label {
    font-size: 12px;
    font-family: var(--figma-font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif);
    color: var(--figma-color-text);
  }

  .checkbox__link {
    color: var(--figma-color-text-brand);
    text-decoration: none;
  }

  .checkbox__link:hover {
    text-decoration: underline;
  }

  .button {
    width: 100%;
    background-color: var(--figma-color-bg-brand);
    color: var(--figma-color-text-onbrand);
    height: 40px;
    border-radius: 8px;
    font-size: 12px;
    font-family: var(--figma-font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif);
    font-weight: 700;
    border: none;
    transition: background-color 0.1s ease;
  }

  .button:not(:disabled):hover {
    background-color: var(--figma-color-bg-brand-hover);
    cursor: pointer;
  }

  .button--processing,
  .button:disabled {
    background-color: var(--figma-color-bg-disabled);
    color: var(--figma-color-text-disabled);
    cursor: not-allowed;
  }

  .status-text {
    font-size: 12px;
    font-family: var(--figma-font-family, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif);
    color: var(--figma-color-text-secondary);
  }

  .checkbox__input {
    margin-left: 2px;
  }
</style>

<script>
const startButton = document.getElementById('startButton');
const statusText = document.getElementById('statusText');
const checkboxLabel = document.getElementById('checkboxLabel');

// ë ˆì´ë¸” ë³€ìˆ˜
const labels = {
  en: {
    checkbox: {
      prefix: 'Apply ',
      link: 'Apple Typography Tracking',
      url: 'https://developer.apple.com/design/human-interface-guidelines/typography#iOS-iPadOS-visionOS-tracking-values',
      suffix: ''
    },
    startButton: 'Start Font Change',
    statusText: 'Completed: 0/0',
    processing: 'Processing...',
    complete: 'Font Change Complete',
    selectLayer: 'Please select a text layer',
    noSelection: 'Please select a target to change'
  },
  ko: {
    checkbox: {
      prefix: '',
      link: 'ì• í”Œ ê³µì‹ ìê°„ ê°’',
      url: 'https://developer.apple.com/design/human-interface-guidelines/typography#iOS-iPadOS-visionOS-tracking-values',
      suffix: ' ì ìš©'
    },
    startButton: 'í°íŠ¸ ë³€ê²½ ì‹œì‘',
    statusText: 'ë³€ê²½ëœ ê¸€ì: 0/0',
    processing: 'ì²˜ë¦¬ ì¤‘...',
    complete: 'í°íŠ¸ ë³€ê²½ ì™„ë£Œ',
    selectLayer: 'í…ìŠ¤íŠ¸ ë ˆì´ì–´ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”',
    noSelection: 'ë³€ê²½í•  ëŒ€ìƒì„ ì„ íƒí•´ì£¼ì„¸ìš”'
  }
};

// ì‹œìŠ¤í…œ ì–¸ì–´ì— ë”°ë¼ ë ˆì´ë¸” ì„ íƒ
const lang = navigator.language.startsWith('ko') ? 'ko' : 'en';
const currentLabels = labels[lang];

// ë ˆì´ë¸” ì„¤ì •
checkboxLabel.innerHTML = `${currentLabels.checkbox.prefix}<a href="${currentLabels.checkbox.url}" class="checkbox__link" target="_blank">${currentLabels.checkbox.link}</a>${currentLabels.checkbox.suffix}`;
startButton.textContent = currentLabels.noSelection;
statusText.textContent = currentLabels.statusText;

// í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œë¶€í„° ë©”ì‹œì§€ ìˆ˜ì‹ 
onmessage = (event) => {
  const msg = event.data.pluginMessage;
  
  if (msg.type === 'selection-change') {
    startButton.disabled = !msg.hasValidSelection;
    
    if (!msg.hasValidSelection) {
      startButton.textContent = currentLabels.noSelection;
      startButton.title = currentLabels.selectLayer;
    } else {
      startButton.textContent = currentLabels.startButton;
      startButton.title = '';
    }
  } else if (msg.type === 'update-button-state') {
    if (msg.state === 'processing') {
      updateButtonToProcessing();
    }
  } else if (msg.type === 'update-status') {
    statusText.textContent = msg.message;
  } else if (msg.type === 'process-complete') {
    statusText.textContent = msg.message;
    startButton.textContent = currentLabels.startButton;
    startButton.disabled = false;
    startButton.classList.remove('button--processing');
  }
};

// ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
function updateButtonToProcessing() {
  console.log('ğŸ”„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œì‘');
  startButton.disabled = true;
  startButton.textContent = currentLabels.processing;
  startButton.classList.add('button--processing');
  statusText.textContent = currentLabels.statusText;
  console.log('âœ“ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
}

startButton.onclick = async () => {
  console.log('ğŸ‘† ë²„íŠ¼ í´ë¦­ë¨');
  
  // 1. ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸ (ë‹¤ë¥¸ ì‘ì—… ì „ì— ë¨¼ì € ì‹¤í–‰)
  console.log('ğŸ”„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì‹œì‘');
  startButton.disabled = true;
  startButton.textContent = currentLabels.processing;
  startButton.classList.add('button--processing');
  statusText.textContent = currentLabels.statusText;
  console.log('âœ“ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ');

  // UI ì—…ë°ì´íŠ¸ê°€ ë°˜ì˜ë  ìˆ˜ ìˆë„ë¡ ì ì‹œ ëŒ€ê¸°
  await new Promise(resolve => requestAnimationFrame(resolve));

  // 2. ë©”ì‹œì§€ ì „ì†¡
  console.log('ğŸ“¤ í”ŒëŸ¬ê·¸ì¸ìœ¼ë¡œ ë©”ì‹œì§€ ì „ì†¡');
  const applyTracking = document.getElementById('applyTracking').checked;
  parent.postMessage({ 
    pluginMessage: { 
      type: 'start-font-change',
      applyTracking,
      lang: navigator.language.startsWith('ko') ? 'ko' : 'en'
    }
  }, '*');
}
</script> 